import json
import os
import unittest

import responses

import pricing.client as client


class CoinmarketcapTest(unittest.TestCase):
    def setUp(self):
        with open('pricing/client/test/coinmarketcap_success.json') as fd:
            self.res_success = json.load(fd)
            self.coins = [{'name': 'BTC'},
                          {'name': 'XRP'},
                          {'name': 'ETH'},
                          {'name': 'EOS'},
                          {'name': 'LTC'},
                          {'name': 'BCH'},
                          {'name': 'BNB'},
                          {'name': 'USDT'},
                          {'name': 'XLM'},
                          {'name': 'TRX'},
                          {'name': 'ADA'},
                          {'name': 'BSV'},
                          {'name': 'XMR'},
                          {'name': 'IOT'},
                          {'name': 'DASH'},
                          {'name': 'MKR'},
                          {'name': 'HT'},
                          {'name': 'NEO'},
                          {'name': 'DCN'},
                          {'name': 'ONT'},
                          {'name': 'ETC'},
                          {'name': 'LINK'},
                          {'name': 'XEM'},
                          {'name': 'KBC'},
                          {'name': 'QKC'},
                          {'name': 'ZEC'},
                          {'name': 'WAVES'},
                          {'name': 'VET'},
                          {'name': 'ZRX'},
                          {'name': 'HOT*'},
                          {'name': 'DOGE'},
                          {'name': 'USDC'},
                          {'name': 'BEC'},
                          {'name': 'ZIL'},
                          {'name': 'QTUM'},
                          {'name': 'BTG'},
                          {'name': 'TUSD'},
                          {'name': 'BAT'},
                          {'name': 'NPXS'},
                          {'name': 'QNT'},
                          {'name': 'OMG'},
                          {'name': 'IOST'},
                          {'name': 'DCR'},
                          {'name': 'REP'},
                          {'name': 'SNT'},
                          {'name': 'LSK'},
                          {'name': 'XET'},
                          {'name': 'GNO'},
                          {'name': 'BCD'},
                          {'name': 'R'},
                          {'name': 'BTM*'},
                          {'name': 'NANO'},
                          {'name': 'DGB'},
                          {'name': 'BTS'},
                          {'name': 'PAX'},
                          {'name': 'QASH'},
                          {'name': 'STORJ'},
                          {'name': 'KMD'},
                          {'name': 'FTO'},
                          {'name': 'XVG'},
                          {'name': 'ICX'},
                          {'name': 'MANA'},
                          {'name': 'ABBC'},
                          {'name': 'DENT'},
                          {'name': 'THETA'},
                          {'name': 'MCO'},
                          {'name': 'POWR'},
                          {'name': 'BZ'},
                          {'name': 'STRAT'},
                          {'name': 'POLY*'},
                          {'name': 'SC'},
                          {'name': 'KCS'},
                          {'name': 'WAX'},
                          {'name': 'LRC'},
                          {'name': 'AOA'},
                          {'name': 'IOTX'},
                          {'name': 'WTC'},
                          {'name': 'EDO'},
                          {'name': 'ARK'},
                          {'name': 'GNT'},
                          {'name': 'PPT'},
                          {'name': 'DYN'},
                          {'name': 'PAI*'},
                          {'name': 'NAS'},
                          {'name': 'CVC'},
                          {'name': 'TOMO'},
                          {'name': 'FCT'},
                          {'name': 'MAID'},
                          {'name': 'ARDR'},
                          {'name': 'ENG'},
                          {'name': 'HC'},
                          {'name': 'HSR'},
                          {'name': 'PAY'},
                          {'name': 'LOOM'},
                          {'name': 'AGI'},
                          {'name': 'PIVX'},
                          {'name': 'ELF'},
                          {'name': 'EDR*'},
                          {'name': 'SAN'},
                          {'name': 'PRG'}]
            self.prices = {'ABBC': 0.103856294635,
                           'ADA': 0.0460289735259,
                           'AGI': 0.04721937954,
                           'AOA': 0.0112674542013,
                           'ARDR': 0.058333417672,
                           'ARK': 0.6297277402,
                           'BAT': 0.137313853928,
                           'BCD': 0.775964377025,
                           'BCH': 143.335599437,
                           'BNB': 10.5693959931,
                           'BSV': 65.4203538701,
                           'BTC': 3977.00789198,
                           'BTG': 12.8243591876,
                           'BTS': 0.0482162838289,
                           'BZ': 0.0784408753116,
                           'CVC': 0.0605600810936,
                           'DASH': 85.5645440745,
                           'DCN': 7.60565664799e-05,
                           'DCR': 17.4264620127,
                           'DENT': 0.000955793823767,
                           'DGB': 0.010426297105,
                           'DOGE': 0.00204684613373,
                           'DYN': 0.209340901247,
                           'EDO': 0.822537782912,
                           'ELF': 0.146091358798,
                           'ENG': 0.36354783335,
                           'EOS': 3.84225752139,
                           'ETC': 4.66236994182,
                           'ETH': 148.537042394,
                           'FCT': 6.71680494083,
                           'FTO': 3.30828321567,
                           'GNO': 14.3978005103,
                           'GNT': 0.0679086752587,
                           'HC': 1.20110170977,
                           'HT': 1.23096366421,
                           'ICX': 0.264769151314,
                           'IOST': 0.00793022225062,
                           'IOTX': 0.00756474866218,
                           'KBC': 0.0303968058717,
                           'KCS': 0.469439231815,
                           'KMD': 0.934759799428,
                           'LINK': 0.447086071646,
                           'LOOM': 0.0482834735853,
                           'LRC': 0.0567622017179,
                           'LSK': 1.26044052294,
                           'LTC': 48.979968998,
                           'MAID': 0.129992251333,
                           'MANA': 0.0364928109062,
                           'MCO': 2.94289532271,
                           'MKR': 689.476235316,
                           'NANO': 0.914837279789,
                           'NAS': 0.689129224057,
                           'NEO': 8.91534889759,
                           'NPXS': 0.00069393260324,
                           'OMG': 1.2908256439,
                           'ONT': 0.933121054573,
                           'PAX': 1.01325307303,
                           'PAY': 0.248215236858,
                           'PIVX': 0.78433849156,
                           'POWR': 0.0957377273936,
                           'PPT': 1.28280515135,
                           'PRG': 0.299904664064,
                           'QASH': 0.119676529326,
                           'QKC': 0.033076604239,
                           'QNT': 4.07538382691,
                           'QTUM': 2.26598809652,
                           'R': 0.137772358633,
                           'REP': 13.9045872466,
                           'SAN': 0.528326546083,
                           'SC': 0.0025406128631,
                           'SNT': 0.0218326830308,
                           'STORJ': 0.242855173798,
                           'STRAT': 0.918921265282,
                           'THETA': 0.0957945613718,
                           'TOMO': 0.592696251148,
                           'TRX': 0.0250678930737,
                           'TUSD': 1.01347596371,
                           'USDC': 1.01131852548,
                           'USDT': 1.00733281787,
                           'VET': 0.00469282528366,
                           'WAVES': 2.83455041537,
                           'WAX': 0.0443598233916,
                           'WTC': 1.10963140505,
                           'XEM': 0.0456263333415,
                           'XET': 0.743804295518,
                           'XLM': 0.0907742827867,
                           'XMR': 52.4111523617,
                           'XRP': 0.318832228124,
                           'XVG': 0.00648999221516,
                           'ZEC': 54.1497887195,
                           'ZIL': 0.0188400138562,
                           'ZRX': 0.247983152977}

    def test_load_config(self):
        expected = 'some_api_token'
        os.environ['COINMARKETCAP_API_TOKEN'] = expected
        config = client.load_config()

        assert config['api_token'] == expected

    @responses.activate
    def test_get_prices(self):
        config = {'url': 'http://localhost/',
                  'api_token': 'sometoken'}
        responses.add(
            responses.GET,
            config['url'],
            json=self.res_success)

        result = client.get_prices(config, self.coins)
        assert len(responses.calls) == 1
        assert len(result) == 100

        assert responses.calls[0].request.url == config['url'] + '?symbol=BTC%2CXRP%2CETH%2CEOS%2CLTC%2CBCH%2CBNB%2CUSDT%2CXLM%2CTRX%2CADA%2CBSV%2CXMR%2CDASH%2CMKR%2CHT%2CNEO%2CDCN%2CONT%2CETC%2CLINK%2CXEM%2CKBC%2CQKC%2CZEC%2CWAVES%2CVET%2CZRX%2CHOT%2CDOGE%2CUSDC%2CZIL%2CQTUM%2CBTG%2CTUSD%2CBAT%2CNPXS%2CQNT%2COMG%2CIOST%2CDCR%2CREP%2CSNT%2CLSK%2CXET%2CGNO%2CBCD%2CR%2CBTM%2CNANO%2CDGB%2CBTS%2CPAX%2CQASH%2CSTORJ%2CKMD%2CFTO%2CXVG%2CICX%2CMANA%2CABBC%2CDENT%2CTHETA%2CMCO%2CPOWR%2CBZ%2CSTRAT%2CPOLY%2CSC%2CKCS%2CWAX%2CLRC%2CAOA%2CIOTX%2CWTC%2CEDO%2CARK%2CGNT%2CPPT%2CDYN%2CPAI%2CNAS%2CCVC%2CTOMO%2CFCT%2CMAID%2CARDR%2CENG%2CHC%2CPAY%2CLOOM%2CAGI%2CPIVX%2CELF%2CEDR%2CSAN%2CPRG'
        assert responses.calls[0].request.headers['X-CMC_PRO_API_KEY'] == config['api_token']

    def test_parse_api_response(self):
        result = client.parse_api_response(self.res_success)
        expected = self.prices

        assert result == expected

    def test_augment(self):
        result = client.augment(self.coins, self.prices)

        assert result == [{'BTC': 3977.00789198},
                          {'XRP': 0.318832228124},
                          {'ETH': 148.537042394},
                          {'EOS': 3.84225752139},
                          {'LTC': 48.979968998},
                          {'BCH': 143.335599437},
                          {'BNB': 10.5693959931},
                          {'USDT': 1.00733281787},
                          {'XLM': 0.0907742827867},
                          {'TRX': 0.0250678930737},
                          {'ADA': 0.0460289735259},
                          {'BSV': 65.4203538701},
                          {'XMR': 52.4111523617},
                          {'IOT': '-'},
                          {'DASH': 85.5645440745},
                          {'MKR': 689.476235316},
                          {'HT': 1.23096366421},
                          {'NEO': 8.91534889759},
                          {'DCN': 7.60565664799e-05},
                          {'ONT': 0.933121054573},
                          {'ETC': 4.66236994182},
                          {'LINK': 0.447086071646},
                          {'XEM': 0.0456263333415},
                          {'KBC': 0.0303968058717},
                          {'QKC': 0.033076604239},
                          {'ZEC': 54.1497887195},
                          {'WAVES': 2.83455041537},
                          {'VET': 0.00469282528366},
                          {'ZRX': 0.247983152977},
                          {'HOT*': '-'},
                          {'DOGE': 0.00204684613373},
                          {'USDC': 1.01131852548},
                          {'BEC': '-'},
                          {'ZIL': 0.0188400138562},
                          {'QTUM': 2.26598809652},
                          {'BTG': 12.8243591876},
                          {'TUSD': 1.01347596371},
                          {'BAT': 0.137313853928},
                          {'NPXS': 0.00069393260324},
                          {'QNT': 4.07538382691},
                          {'OMG': 1.2908256439},
                          {'IOST': 0.00793022225062},
                          {'DCR': 17.4264620127},
                          {'REP': 13.9045872466},
                          {'SNT': 0.0218326830308},
                          {'LSK': 1.26044052294},
                          {'XET': 0.743804295518},
                          {'GNO': 14.3978005103},
                          {'BCD': 0.775964377025},
                          {'R': 0.137772358633},
                          {'BTM*': '-'},
                          {'NANO': 0.914837279789},
                          {'DGB': 0.010426297105},
                          {'BTS': 0.0482162838289},
                          {'PAX': 1.01325307303},
                          {'QASH': 0.119676529326},
                          {'STORJ': 0.242855173798},
                          {'KMD': 0.934759799428},
                          {'FTO': 3.30828321567},
                          {'XVG': 0.00648999221516},
                          {'ICX': 0.264769151314},
                          {'MANA': 0.0364928109062},
                          {'ABBC': 0.103856294635},
                          {'DENT': 0.000955793823767},
                          {'THETA': 0.0957945613718},
                          {'MCO': 2.94289532271},
                          {'POWR': 0.0957377273936},
                          {'BZ': 0.0784408753116},
                          {'STRAT': 0.918921265282},
                          {'POLY*': '-'},
                          {'SC': 0.0025406128631},
                          {'KCS': 0.469439231815},
                          {'WAX': 0.0443598233916},
                          {'LRC': 0.0567622017179},
                          {'AOA': 0.0112674542013},
                          {'IOTX': 0.00756474866218},
                          {'WTC': 1.10963140505},
                          {'EDO': 0.822537782912},
                          {'ARK': 0.6297277402},
                          {'GNT': 0.0679086752587},
                          {'PPT': 1.28280515135},
                          {'DYN': 0.209340901247},
                          {'PAI*': '-'},
                          {'NAS': 0.689129224057},
                          {'CVC': 0.0605600810936},
                          {'TOMO': 0.592696251148},
                          {'FCT': 6.71680494083},
                          {'MAID': 0.129992251333},
                          {'ARDR': 0.058333417672},
                          {'ENG': 0.36354783335},
                          {'HC': 1.20110170977},
                          {'HSR': '-'},
                          {'PAY': 0.248215236858},
                          {'LOOM': 0.0482834735853},
                          {'AGI': 0.04721937954},
                          {'PIVX': 0.78433849156},
                          {'ELF': 0.146091358798},
                          {'EDR*': '-'},
                          {'SAN': 0.528326546083},
                          {'PRG': 0.299904664064}]
